var BLOCKED_SRC_ATTR="blocked-src",gImageLoadElements=[],gScaleInfo,gImagesToLoad=0,TRANSFORM_MINIMUM_EFFECTIVE_RATIO=.7,DEBUG_DISPLAY_TRANSFORMS=!1,gTransformText={},isDef=function(a){return void 0!==a};function getTotalOffset(a){for(var b={left:0,top:0};a;)b.left+=a.offsetLeft,b.top+=a.offsetTop,a=a.offsetParent;return b}function getAncestorByClassName(a,b){for(;a&&(!a.classList||!a.classList.contains(b));)a=a.parentNode;return a||null}
function getAncestorByTagName(a,b){for(;a&&(!a.tagName||a.tagName.toLowerCase()!==b);)a=a.parentNode;return a||null}function getCachedValue(a,b,c){a.hasAttribute(c)?b=a.getAttribute(c):(b=a[b],a.setAttribute(c,b));return b}function onToggleMessageClick(a){onToggleClick(a,!1)}function onToggleQuotedClick(a){onToggleClick(a,!0)}function onToggleClick(a,b){toggleNextElement(a.target,b);measurePositions(!1)}
function toggleNextElement(a,b){var c=a.nextSibling,d="none"==getComputedStyle(c).display;a.innerHTML=getToggleText(d,b);c.style.display=d?"block":"none";d&&normalizeElementWidths([c])}function getToggleText(a,b){return b?a?MSG_HIDE_ELIDED:MSG_SHOW_ELIDED:a?MSG_HIDE_ORIGINAL:MSG_SHOW_ORIGINAL}function collapseAllQuotedText(){processCollapsedMessageBodies(document.documentElement);processQuotedText(document.documentElement,!1)}
function processCollapsedMessageBodies(a){a=a.getElementsByClassName("mail-message-toggle");for(var b=0,c;c=a[b];b++)c.innerHTML=MSG_SHOW_ORIGINAL,c.onclick=onToggleMessageClick}
function processQuotedText(a,b){a=a.getElementsByClassName("elided-text");for(var c,d=0,e;e=a[d];d++)c=document.createElement("div"),c.className="mail-elided-text",c.innerHTML=MSG_SHOW_ELIDED,c.setAttribute("dir","auto"),c.onclick=onToggleQuotedClick,e.style.display="none",e.parentNode.insertBefore(c,e),b&&toggleNextElement(c,!0)}function isConversationEmpty(a){var b;var c=0;for(b=a.length;c<b;c++){var d=a[c];d=d.textContent||d.innerText;if(0<d.trim().length)return!1}return!0}
function reloadImage(a){a=document.querySelectorAll('img[src="'+a+'"]');for(var b=0;b<a.length;b++)a[b].src=a[b].src}function normalizeAllMessageWidths(){var a=document.querySelectorAll(".expanded > .mail-message-content");var b=isConversationEmpty(a);normalizeElementWidths(a);a=document.getElementById("meta-viewport");var c=[a.getAttribute("content")];b?c.push(a.getAttribute("data-zoom-off")):c.push(a.getAttribute("data-zoom-on"));a.setAttribute("content",c.join(","))}
function normalizeElementWidths(a){var b,c;var d=document.body.offsetWidth;for(b=0;b<a.length;b++){var e=a[b];if(c=e.style.zoom)e.style.zoom=1;if(!transformContent(e,d,e.scrollWidth)&&NORMALIZE_MESSAGE_WIDTHS){c=e.scrollWidth;c=c>d?d/c:1;var g=e.classList.contains("mail-message-content")?1:(g=getAncestorByClassName(e,"mail-message-content"))?g.style.zoom:1;e.style.zoom=c/g}}}
function transformContent(a,b,c){var d=c;var e=[],g=[],f=!1,h=[];if(c<=b)return!0;var m=Date.now();if(a.parentElement.classList.contains("mail-message")){var k=a.parentElement.id;var l="[origW="+c+"/"+b}d=!1;d=ENABLE_MUNGE_TABLES?a.querySelectorAll("div[style], textarea[style]"):[];if(d=transformBlockElements(d,b,e))d=a.scrollWidth,console.log("ran div-width munger on el="+a+" oldW="+c+" newW="+d+" docW="+b),k&&(l+=" DIV:newW="+d),d<=b&&(f=!0);!f&&(d=ENABLE_MUNGE_IMAGES?a.querySelectorAll("img"):
[],d=transformImages(d,b,e))&&(d=a.scrollWidth,console.log("ran img munger on el="+a+" oldW="+c+" newW="+d+" docW="+b),k&&(l+=" IMG:newW="+d),d<=b&&(f=!0));!f&&(d=ENABLE_MUNGE_TABLES?a.querySelectorAll("table"):[],d=addClassToElements(d,shouldMungeTable,"munged",g))&&(d=a.scrollWidth,console.log("ran table munger on el="+a+" oldW="+c+" newW="+d+" docW="+b),k&&(l+=" TABLE:newW="+d),d<=b&&(f=!0));!f&&(d=ENABLE_MUNGE_TABLES?a.querySelectorAll("td"):[],d=addClassToElements(d,null,"munged",g))&&(d=a.scrollWidth,
console.log("ran td munger on el="+a+" oldW="+c+" newW="+d+" docW="+b),k&&(l+=" TD:newW="+d),d<=b?f=!0:(console.log("Revert table and td munger because it didn't help"),undoActions(g)));!f&&NORMALIZE_MESSAGE_WIDTHS&&(g=document.querySelectorAll("table"),h=zoomOutTables(g,b,e),0<h.length&&(h.forEach(function(a){a.node.style.display="none"}),d=a.scrollWidth,console.log("ran table zoom on el="+a+" oldW="+c+" newW="+d+" docW="+b),k&&(l+=" TABLEZOOM:newW="+d),d<=b&&(f=!0),h.forEach(function(a){a.node.style.display=
a.displayStyle})));if(f)return k&&(l+="]",l=(b=gTransformText[k])?b+" "+l:"Message transforms: "+l,gTransformText[k]=l,window.mail.onMessageTransform(k,l),DEBUG_DISPLAY_TRANSFORMS&&(k=a.firstChild,k.classList&&k.classList.contains("transform-text")||(k=document.createElement("div"),k.classList.add("transform-text"),k.style.fontSize="10px",k.style.color="#ccc",a.insertBefore(k,a.firstChild)),k.innerHTML=l+"<br>")),console.log("munger(s) succeeded, elapsed time="+(Date.now()-m)),!0;undoActions(e);0<
e.length&&console.log("all mungers failed, changes reversed. elapsed time="+(Date.now()-m));return!1}function undoActions(a){for(var b=0,c;c=a[b];b++)c[0].apply(c[1],c[2])}function addClassToElements(a,b,c,d){var e,g=!1;var f=0;for(e=a.length;f<e;f++){var h=a[f];b&&!b(h)||h.classList.contains(c)||(h.classList.add(c),g=!0,d.push([h.classList.remove,h.classList,[c]]))}return g}
function transformBlockElements(a,b,c){var d,e,g=!1;var f=0;for(d=a.length;f<d;f++){var h=a[f];var m=(e=h.style.width||h.style.minWidth)?e.indexOf("px"):-1;0<=m&&e.slice(0,m)>b&&(saveStyleProperty(h,"width",c),saveStyleProperty(h,"minWidth",c),saveStyleProperty(h,"maxWidth",c),h.style.width="100%",h.style.minWidth="",h.style.maxWidth=e,g=!0)}return g}
function transformImages(a,b,c){var d,e=!1;var g=0;for(d=a.length;g<d;g++){var f=a[g];if(!getAncestorByTagName(f,"table")){var h=f.offsetWidth;var m=f.offsetHeight;h>b&&(saveStyleProperty(f,"maxWidth",c),saveStyleProperty(f,"width",c),saveStyleProperty(f,"height",c),f.style.maxWidth=b+"px",f.style.width="100%",f.style.height=5>m?m:"auto",e=!0)}}return e}
function zoomOutTables(a,b,c){var d=[];a=[].slice.call(a);a.forEach(function(a){a.classList.remove("zoom-out");a.style.zoom=1});a.forEach(function(a){if(!getAncestorByClassName(a,"zoom-out")){var e=b/a.scrollWidth;1>e&&(saveStyleProperty(a,"zoom",c),c.push([a.classList.remove,a.classList,["zoom-out"]]),a.style.zoom=e,a.classList.add("zoom-out"),console.log("zoomed out the table"),d.push({node:a,displayStyle:a.style.display}))}});return d}
function saveStyleProperty(a,b,c){var d="data-"+b;a.setAttribute(d,a.style[b]);c.push([undoSetProperty,a,[b,d]])}function undoSetProperty(a,b){this.style[a]=b?this.getAttribute(b):""}function shouldMungeTable(a){return a.hasAttribute("width")||a.style.width}function hideAllUnsafeImages(){hideUnsafeImages(document.getElementsByClassName("mail-message-content"))}
function hideUnsafeImages(a){var b,c,d=0,e=[],g=[];var f=0;for(b=a.length;f<b;f++){var h=a[f];var m=h.classList.contains("mail-show-images");var k=h.getElementsByTagName("img");gImagesToLoad=k.length;var l=0;for(c=k.length;l<c;l++){var p=k[l];var n=rewriteRelativeImageSrc(p);n&&(e[d]=n,g[d]=h.parentNode.id,d++);attachImageLoadListener(p);(!m||n&&"cid:"==n.substring(0,4))&&blockImage(p)}}window.mail.onInlineAttachmentsParsed(e,g);if(0<e.length)window.mail.onImageLoadRequestsCreated(e.length)}
function unblockAllTemporarilyHiddenImages(){var a,b;var c=document.getElementsByClassName("mail-message-content");var d=0;for(a=c.length;d<a;d++){var e=c[d];if(b=e.classList.contains("mail-show-images")){var g=e.getElementsByTagName("img");e=0;for(b=g.length;e<b;e++)unblockImage(g[e])}}}
function rewriteRelativeImageSrc(a){var b=a.src;return 0==b.indexOf(DOC_BASE_URI)&&DOC_BASE_URI!=CONVERSATION_BASE_URI?(b=CONVERSATION_BASE_URI+b.substring(DOC_BASE_URI.length),a.src=b):SAPI_INLINE_IMAGE_URL_PATTERN&&b.match(SAPI_INLINE_IMAGE_URL_PATTERN)||"cid:"==b.substring(0,4)?b:null}function attachImageLoadListener(a){var b=a.src;a.src="";a.onload=imageOnLoad;a.src=b}
function imageOnLoad(a){gImagesToLoad--;if(0===gImagesToLoad){for(var b=document.getElementsByClassName("gmail-ads-delayed-elements"),c=0;c<b.length;c++)b[c].style.visibility="visible";window.mail.onAllContentLoaded()}if(a&&a.target&&isDef(a.target.src))window.mail.onImageLoadFinished(a.target.src);if(a=getAncestorByClassName(a.target,"elided-text")||getAncestorByClassName(a.target,"mail-message-content"))0==gImageLoadElements.length&&window.setTimeout(handleAllImageOnLoads,0),-1==gImageLoadElements.indexOf(a)&&
gImageLoadElements.push(a)}function handleAllImageOnLoads(){normalizeElementWidths(gImageLoadElements);measurePositions(!1);window.mail.onAllImagesLoadFinished();gImageLoadElements=[]}function blockImage(a){var b=a.src;if(0==b.indexOf("http://")||0==b.indexOf("https://")||0==b.indexOf("content://")||0==b.indexOf("cid:"))a.setAttribute(BLOCKED_SRC_ATTR,b),a.src="blocked"}function setWideViewport(){document.getElementById("meta-viewport").setAttribute("content","width="+WIDE_VIEWPORT_WIDTH)}
function restoreScrollPosition(){var a=window.mail.getScrollYPercent();a&&document.body.offsetHeight>window.innerHeight&&(document.body.scrollTop=Math.floor(a*document.body.offsetHeight))}function onContentReady(a){RUNNING_KITKAT_OR_LATER&&restoreScrollPosition();window.mail.onContentReady()}
function setupContentReady(){if(ENABLE_CONTENT_READY&&!USE_DOM_CONTENT_LOADED_SIGNAL){var a=document.getElementById("initial-load-signal");a.addEventListener("webkitAnimationStart",onContentReady,!1);window.mail.createTracingInstant("InitialLoadListenerAdded")}}
function measurePositions(a){var b,c=0,d=document.querySelectorAll(".expanded > .mail-message-content");var e=Array(d.length+1);var g=Array(d.length+1);var f=0;for(b=d.length;f<b;f++){var h=d[f];var m=h.previousElementSibling;e[f]=c;g[f]=getTotalOffset(m).top+m.offsetHeight;c=getTotalOffset(h.nextElementSibling).top}e[f]=c;g[f]=document.documentElement.scrollHeight;a&&console.log("overlayTops: "+e.toString()+"; overlayBottoms: "+g.toString());window.mail.onWebContentGeometryChange(e,g)}
function unblockImages(a){for(var b,c,d=c=0,e;e=a[d];d++)if(b=document.getElementById(e)){(e=b.getElementsByClassName("mail-message-content")[0])&&e.classList.add("mail-show-images");b=b.getElementsByTagName("img");c+=b.length;e=0;for(var g;g=b[e];e++)unblockImage(g)}else console.log("can't unblock, no matching message for id: "+e);if(0<c)window.mail.onImageLoadRequestsCreated(c)}function unblockImage(a){var b;if(b=a.getAttribute(BLOCKED_SRC_ATTR))a.src=b,a.removeAttribute(BLOCKED_SRC_ATTR)}
function setConversationHeaderSpacerHeight(a){var b=document.getElementById("conversation-header");b?(b.style.height=a+"px",measurePositions(!1)):console.log("can't set spacer for conversation header")}function setConversationPromotionSpacerHeight(a){var b=document.getElementById("conversation-promotion");b?(b.style.height=a+"px",measurePositions(!1)):console.log("can't set spacer for conversation promotion")}
function setConversationFooterSpacerHeight(a){var b=document.getElementById("conversation-footer");b?(b.style.height=a+"px",measurePositions(!1)):console.log("can't set spacer for conversation footer")}function setMessageHeaderSpacerHeight(a,b){a=document.querySelector("#"+a+" > .mail-message-header");setSpacerHeight(a,b)}function setSpacerHeight(a,b){a?(a.style.height=b+"px",measurePositions(!1)):console.log("can't set spacer height")}
function setMessageBodyVisible(a,b,c){var d,e=b?"block":"none",g=document.querySelector("#"+a),f=document.querySelectorAll("#"+a+" > .collapsible");if(g&&0!=f.length){g.classList.toggle("expanded");var h=0;for(d=f.length;h<d;h++)f[h].style.display=e;b&&normalizeElementWidths(g.getElementsByClassName("mail-message-content"));setMessageHeaderSpacerHeight(a,c)}else console.log("can't set body visibility for message with id: "+a)}
function replaceSuperCollapsedBlock(a){var b,c;if(b=document.querySelector(".mail-super-collapsed-block[index='"+a+"']")){a=b.parentNode;b.innerHTML=window.mail.getTempMessageBodies();processCollapsedMessageBodies(b);processQuotedText(b,!1);hideUnsafeImages(b.getElementsByClassName("mail-message-content"));for(c=b.firstChild;c;)a.insertBefore(c,b),c=b.firstChild;a.removeChild(b);disablePostForms();measurePositions(!1)}else console.log("can't expand super collapsed block at index: "+a)}
function processNewMessageBody(a){processCollapsedMessageBodies(a);processQuotedText(a,!0);hideUnsafeImages([a]);getAncestorByClassName(a,"mail-message").classList.contains("expanded")&&normalizeElementWidths([a])}
function replaceMessageBodies(a){for(var b,c=0,d;d=a[c];c++)(b=document.querySelector("#"+d+" > .mail-message-content"))?(b.innerHTML=window.mail.getMessageBody(d),processNewMessageBody(b)):console.log("Mail message content for msg "+d+" to replace not found.");disablePostForms();measurePositions(!1)}
function appendMessageHtml(){var a=document.createElement("div");a.innerHTML=window.mail.getTempMessageBodies();a=a.children[0];document.body.insertBefore(a,document.getElementById("conversation-footer"));processNewMessageBody(a.querySelector(".mail-message-content"));disablePostForms();measurePositions(!1)}
function disablePostForms(){var a=document.getElementsByTagName("FORM"),b,c;for(b=0;b<a.length;++b)if("POST"===a[b].method.toUpperCase()){a[b].onsubmit=function(){alert(MSG_FORMS_ARE_DISABLED);return!1};var d=a[b].elements;for(c=0;c<d.length;++c)"submit"!=d[c].type&&(d[c].disabled=!0)}}function findMailMessageNode(a){for(;(a=a.parentElement)&&!a.classList.contains("mail-message"););return a}
function encodeGmailLink(a,b){var c="";SAFELINKS_V1&&(c=b.getAttribute("data-saferedirecturl")||"");var d="";SAFELINKS_V2&&(d=b.getAttribute("data-saferedirectreason")||"");a="gmail-link://?url="+encodeURIComponent(a);c&&(a+="&safeRedirectUrl="+encodeURIComponent(c));d&&(a+="&safeRedirectReason="+encodeURIComponent(d));GMAIL_LINK_ENCODING&&(b=findMailMessageNode(b),null!=b&&(a+="&msgId="+encodeURIComponent(b.id)));return a}function isAnchorUrl(a){return"#"==a[0]}
function registerLinkHandlers(){for(var a=document.getElementsByTagName("A"),b=0;b<a.length;++b)(function(a){var b=a.getAttribute("href");b&&!isAnchorUrl(b)&&a.addEventListener("click",function(c){window.location=encodeGmailLink(b,a);c.preventDefault()},!0)})(a[b])}
if(!window.webkit){document.addEventListener("DOMContentLoaded",function(){window.mail.createTracingInstant("DOMContentLoaded");console.log("Measure positions upon DOMContentLoaded");measurePositions(!0);ENABLE_CONTENT_READY&&USE_DOM_CONTENT_LOADED_SIGNAL&&onContentReady(!1)});setupContentReady();for(var gAdDelayedElements=document.getElementsByClassName("gmail-ads-delayed-elements"),i=0;i<gAdDelayedElements.length;i++)gAdDelayedElements[i].style.visibility="hidden";IS_MESSAGE_BASED_UI_ENABLED||collapseAllQuotedText();
hideAllUnsafeImages();normalizeAllMessageWidths();RUNNING_KITKAT_OR_LATER||restoreScrollPosition();disablePostForms();console.log("Measure positions in script.js");measurePositions(!0);registerLinkHandlers()};
